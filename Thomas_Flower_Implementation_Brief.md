# Implementation Brief — “Thomas Flower” Interactive Visualizer

**Goal:** Build a web visualizer for the Thomas attractor that, in addition to the standard 3D point cloud, exposes a **floral projection** (rhodonea overlay) and a computable **Flower Index (FI)** in real time. The attractor is
\(\dot x=\sin(y)-bx,\ \dot y=\sin(z)-by,\ \dot z=\sin(x)-bz\), with chaos near \(b\approx 0.19\).

---

## 1) Template / Base

Use the structure and style of `jcponce/calculus`’s `velfields/Thomas/thomas.js` as **inspiration and template** (sketch loop, camera/orbit controls, particles, minimal HUD). This is **not** a one‑to‑one copy; we extend it with the “Flower” layer.

---

## 2) Data Contract (Preset Loader)

Load presets from a JSON file (generated by our Python pipeline) with this schema:

```json
{
  "id": "canonical_xy",
  "description": "Baseline fit on XY projection; rotational projection = identity",
  "model": { "b": 0.19, "dt": 0.01, "steps": 300000, "transient_steps": 2000, "seed": [0.1, 0.0, 0.0] },
  "projection": { "plane": "xy", "rotation": { "axis": "z", "angle_rad": 0.0 } },
  "rhodonea": { "k": 3.96, "m": 24.26, "phi": -0.286, "a": 3.74, "formula": "r(theta) = a * cos(k*m*theta + phi)" },
  "metrics": { "E_flower": 0.120, "lambda_max": 0.103, "FI_computed": 0.8054705, "FI_reported": 0.8054705 },
  "notes": "Values from phenomenological fit; use as seed for refits under rotations."
}
```

**Paired assets (produced by the Python toolchain):**
- `thomas_flower_js_config.json` — JSON presets for the web visualizer
- `thomas_flower_params.csv` and `thomas_flower_params_enriched.csv` — parameter table with computed FI
- `thomas_flower_interface.py` — CLI to regenerate JSON/CSV and recompute FI

---

## 3) UI / UX Objectives

- **Main 3D View:** Thomas attractor rendered as a particle cloud/trails (camera orbit controls, adjustable opacity).
- **Floral Panel (2D):** A togglable panel showing the projection onto a selected plane (default XY):
  - Scatter of \((r,\theta)\) derived from the projection (e.g., \((x,y)\to r=\sqrt{x^2+y^2},\ \theta=\mathrm{atan2}(y,x))\).
  - **Rhodonea overlay** \(r(\theta) = a\cos(k m\theta + \phi)\) using preset parameters.
- **HUD:** display \(b\), \(E_{\text{flower}}\) (RMSE), \(\lambda\), and **FI**.
- **Controls:**
  - Slider/keys for \(b\).
  - Toggle “Floral View” on/off.
  - Plane selector: XY / YZ / ZX.
  - Opacity for 3D attractor and floral overlay.
- **Export:** button to download current PNG and a JSON report of current metrics/settings.

---

## 4) Numerical Core

- **Integration:** step \(dt\) from preset. Euler is acceptable; RK4 as an optional mode if performance allows.
- **Transient:** skip `transient_steps` before collecting samples for the projection.
- **Rotation (optional):** apply the configured rotation `(axis, angle_rad)` before projecting.
- **Sampling:** sub‑sample every \(s\) steps (e.g., \(s=3\)–\(5\)) to maintain smooth FPS.

---

## 5) Metrics

- **Radial Error** \(E_{\text{flower}}\): for each projected point \((r_i,\theta_i)\) compute \(\hat r_i=a\cos(k m\theta_i+\phi)\) and maintain **RMSE** over a sliding buffer of size \(N\) (e.g., \(N=10^4\)).
- **Flower Index (FI):**
  \[
  FI = \frac{1}{1+E_{\text{flower}}}\,e^{-\lambda}
  \]
  - If live \(\lambda\) is not computed, use `lambda_max` from the preset and label it “λ: preset”.
  - **Optional live \(\lambda\) estimation:** evolve a small perturbation \(\delta\mathbf{x}\), renormalize every \(T\) steps, and estimate \(\lambda \approx \frac{1}{T\,dt}\log\frac{\lVert\delta\mathbf{x}_T\rVert}{\lVert\delta\mathbf{x}_0\rVert}\). Use an exponential moving average for stability.

---

## 6) Proposed Code Structure

```
/* thomas_flower.js (new or integrated mode) */
initScene()               // camera, buffers, HUD
stepThomas(dt, b)         // integrator for the system
applyRotation(p, rot)     // pre-projection rotation
projectToPlane(p, plane)  // -> (x', y') for XY/YZ/ZX
accumulatePolar(xy)       // -> (r, theta), ring buffers
rhodonea(theta, params)   // r_hat
computeEflower()          // RMSE over sliding window
computeFI()               // uses Eflower and lambda
draw3D()                  // main 3D attractor
drawFloralPanel()         // (r, theta) scatter + rhodonea overlay
drawHUD()                 // b, E, λ, FI
loadConfig(json)          // load presets from JSON
bindUI()                  // sliders, toggles, export
```

---

## 7) Acceptance Criteria (Minimum)

1. With preset `canonical_xy`, the rhodonea overlay is stable and the **radial RMSE** is about **0.12 ± 0.02** (with a sufficiently large buffer).
2. The displayed **FI** matches the preset‑based value \((E=0.120,\ \lambda=0.103)\) within **±0.01** when λ is preset.
3. Changing \(b\) updates the 3D cloud and FI with near‑real‑time responsiveness (target ≲100 ms perceived latency at 60 fps).
4. Floral panel toggle and plane selector work without dropping below ~45 fps on mid‑range hardware with ~50k points.

---

## 8) Performance & Robustness

- Use `requestAnimationFrame`; compute metrics **every n frames** (e.g., n=2–4).
- Use ring buffers for points and \((r,\theta)\).
- Clamp extreme \(r\) values and prune outliers (e.g., > P99.9 radial) before RMSE for visual stability.

---

## 9) Licensing & Attribution

Respect the upstream repository’s license and attribution requirements if you reuse code or assets. Include a credit line in the HUD/README as appropriate and verify license terms before distribution.

---

## 10) Deliverables

- `thomas_flower.js` + `index.html` (or integrate the “Flower mode” into an existing `thomas.js`).
- Loader for `thomas_flower_js_config.json` presets.
- HUD + Floral panel + PNG/JSON export.
- Short README: how to run, keys, sliders, and presets.

---

## 11) Quick Start (suggested)

1. Serve the folder with a static server (e.g., `python -m http.server`).
2. Load `thomas_flower_js_config.json` on startup; default to `canonical_xy`.
3. Verify that FI ≈ 0.805 when using the preset λ and E.
4. Stress‑test responsiveness by sweeping b in small increments.
