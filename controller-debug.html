<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Controller Debug</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            font-family: monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
        }
        .section {
            border: 1px solid #0f0;
            padding: 10px;
            overflow-y: auto;
            max-height: 90vh;
        }
        h2 {
            margin-top: 0;
            color: #64b5f6;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            background: rgba(0, 255, 0, 0.1);
            border-left: 3px solid #0f0;
        }
        .error {
            background: rgba(255, 0, 0, 0.1);
            border-left: 3px solid #f00;
            color: #f00;
        }
        #controls {
            background: rgba(15, 15, 25, 0.98);
        }
        #mainCanvas {
            width: 100%;
            height: 400px;
            border: 1px solid #0f0;
        }
    </style>
</head>
<body>
    <div class="section">
        <h2>Controls</h2>
        <div id="controls"></div>
        <canvas id="mainCanvas"></canvas>
    </div>
    
    <div class="section">
        <h2>Event Log</h2>
        <div id="eventLog"></div>
    </div>

    <script type="module">
        const logDiv = document.getElementById('eventLog');
        let eventCount = 0;
        
        function log(message, isError = false) {
            const entry = document.createElement('div');
            entry.className = isError ? 'log-entry error' : 'log-entry';
            entry.textContent = `[${++eventCount}] ${new Date().toLocaleTimeString()} - ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
            console.log(message);
        }
        
        // Override console.error to capture errors
        const originalError = console.error;
        console.error = function(...args) {
            log(`ERROR: ${args.join(' ')}`, true);
            originalError.apply(console, args);
        };
        
        try {
            log('Starting controller debug...');
            
            // Import the app
            const { ThomasAttractorApp } = await import('./src/app.js');
            log('✓ ThomasAttractorApp imported');
            
            // Create app with event logging
            const app = new ThomasAttractorApp({
                mainCanvas: document.getElementById('mainCanvas'),
                floralCanvas: null,
                controlsContainer: document.getElementById('controls'),
                maxParticles: 5000,
                enableVolumetricEffects: false
            });
            
            log('✓ App created successfully');
            
            // Intercept all parameter changes
            const originalHandleParameterChange = app.handleParameterChange.bind(app);
            app.handleParameterChange = function(params) {
                log(`Parameter Change: ${JSON.stringify(params)}`);
                return originalHandleParameterChange(params);
            };
            
            const originalHandleVolumetricChange = app.handleVolumetricChange.bind(app);
            app.handleVolumetricChange = function(params) {
                log(`Volumetric Change: ${JSON.stringify(params)}`);
                return originalHandleVolumetricChange(params);
            };
            
            const originalHandlePresetSelect = app.handlePresetSelect.bind(app);
            app.handlePresetSelect = async function(presetId) {
                log(`Preset Selected: ${presetId}`);
                return await originalHandlePresetSelect(presetId);
            };
            
            const originalHandleExport = app.handleExport.bind(app);
            app.handleExport = async function(type) {
                log(`Export: ${type}`);
                return await originalHandleExport(type);
            };
            
            const originalToggleSimulation = app.toggleSimulation.bind(app);
            app.toggleSimulation = function() {
                const result = originalToggleSimulation();
                log(`Simulation toggled: ${result ? 'Running' : 'Stopped'}`);
                return result;
            };
            
            log('✓ Event interception setup complete');
            
            // Test each control programmatically after a delay
            setTimeout(() => {
                log('--- Starting automated tests ---');
                
                // Find and test sliders
                const sliders = document.querySelectorAll('input[type="range"]');
                log(`Found ${sliders.length} sliders`);
                
                sliders.forEach((slider, index) => {
                    setTimeout(() => {
                        const label = slider.previousElementSibling?.textContent || slider.id || `slider-${index}`;
                        const oldValue = slider.value;
                        const newValue = (parseFloat(slider.min) + parseFloat(slider.max)) / 2;
                        slider.value = newValue;
                        slider.dispatchEvent(new Event('input', { bubbles: true }));
                        log(`Tested slider "${label}": ${oldValue} → ${newValue}`);
                    }, index * 100);
                });
                
                // Test buttons
                setTimeout(() => {
                    const buttons = document.querySelectorAll('button');
                    log(`Found ${buttons.length} buttons`);
                    
                    buttons.forEach((button, index) => {
                        setTimeout(() => {
                            log(`Clicking button: "${button.textContent.trim()}"`);
                            button.click();
                        }, index * 200);
                    });
                }, sliders.length * 100 + 500);
                
                // Test checkboxes
                setTimeout(() => {
                    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                    log(`Found ${checkboxes.length} checkboxes`);
                    
                    checkboxes.forEach((checkbox, index) => {
                        setTimeout(() => {
                            const label = checkbox.nextElementSibling?.textContent || checkbox.id || `checkbox-${index}`;
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                            log(`Toggled checkbox "${label}": ${checkbox.checked}`);
                        }, index * 150);
                    });
                }, sliders.length * 100 + 2000);
                
            }, 1000);
            
            // Make app available globally for manual testing
            window.debugApp = app;
            log('✓ App available as window.debugApp for manual testing');
            
        } catch (error) {
            log(`CRITICAL ERROR: ${error.message}`, true);
            log(error.stack, true);
        }
    </script>
</body>
</html>